<apex:page controller="SurveyMonkey.SurveyCampaignController" tabStyle="Survey_Campaign__tab"  docType="html-5.0">
<!--  Related to Javascript Remoting : Start-->
<style type="text/css" media="screen">
            .dataTables_info { padding-top: 0; display : none; }
            .dataTables_paginate { padding-top: 0; }
            .css_right { float: right; }
            #example_wrapper .fg-toolbar { font-size: 0.8em }
            #theme_links span { float: left; padding: 2px 10px; }
            #example_wrapper { -webkit-box-shadow: 2px 2px 6px #666; box-shadow: 2px 2px 6px #666; border-radius: 5px; }
            #example tbody {
                border-left: 1px solid #AAA;
                border-right: 1px solid #AAA;
            }
            #example thead th:first-child { border-left: 1px solid #AAA; }
            #example thead th:last-child { border-right: 1px solid #AAA; }
            
            #home_Tab a{
               pointer-events: none;
               cursor: default;
            } 
    </style>
    <style type="text/css">
        .header {
            font-size: 25px;
            display: block;
            font-family: Arial;
            margin-left: 500px;
        }
        .custPopup{
            background-color: white;
            border-width: 2px;
            border-style: solid;
            z-index: 9999;
            left: 50%;
            padding:10px;
            position: absolute;
            /* These are the 3 css properties you will need to change so the popup 
            displays in the center of the screen. First set the width. Then set 
            margin-left to negative half of what the width is. You can add 
            the height property for a fixed size pop up if you want.*/
            width: 500px;
            left: 300px;
            top:25px;
        }
        .popupBackground{
            background-color:black;
            opacity: 0.20;
            filter: alpha(opacity = 20);
            position: absolute;
            width: 100%;
            top: 0;
            left: 0;
            z-index: 9998;
            height : 800%;
        }
          
        /* Obsolete
        #dvLoading {
            background: url('https://loadinggif.com/images/image-selection/36.gif') no-repeat scroll center center #000;
            width: 100%;
            position: absolute;
            left: 0px;
            top: 0px;
            height: 100%;
            opacity: 0.5;
            z-index: 9999;
        }*/
    </style> 
<!--  Related to Javascript Remoting : End-->
 
<head>

    <apex:includeScript value="{!URLFOR($Resource.SurveyMonkey__JSDataTable, 'jquery.min.js')}"/>
    <apex:includeScript value="{!URLFOR($Resource.SurveyMonkey__JSDataTable, 'jquery-1.10.1.min.js')}"/>
    <apex:includeScript value="{!URLFOR($Resource.SurveyMonkey__JSDataTable, 'complete.min.js')}"/>
    <apex:includeScript value="{!URLFOR($Resource.SurveyMonkey__JSDataTable, 'jquery.dataTables.min.js')}"/>
    <apex:stylesheet value="{!URLFOR($Resource.SurveyMonkey__JSDataTable, 'demo_table_jui.css')}"/>
    <apex:stylesheet value="{!URLFOR($Resource.SurveyMonkey__JSDataTable, 'jquery-ui-1.7.2.custom.css')}"/>
    <apex:stylesheet value="{!$Resource.SurveyMonkey__SM_Stylesheet}"/>
    <apex:stylesheet value="{!$Resource.SurveyMonkey__sm_app}"/>
    <!-- <apex:stylesheet value="{!URLFOR($Resource.SalesforceGridCSS)}"/> -->
    
<!--**********************************Include the Data Table Script***************************** -->
<script src="/soap/ajax/19.0/connection.js" type="text/javascript" /> 
<!--******************************Header which contain style sheet and script************************** -->  

    <style>
        .radioButtons{
            //margin-top: -8px !important;
        }
        .leftIndented{
            //margin-left: 50px !important;
        }
        .MainHeading{
            font-size: 26px;
        }
        .LeftColumn{
            width:140px;
        }
        .tableData{
            border: 1px solid lightgray;
        }
        .thData{
            background-color: lightgray;
        }
        .tdData{
            background-color: #E8E8E8;
        }
        /*Tab Style*/
        #cssmenu {
            border: none;
            border: 0px;
            margin: 0px;
            padding: 0px;
            font-family: verdana, geneva, arial, helvetica, sans-serif;
            font-size: 14px;
            font-weight: bold;
            color: #8e8e8e;
            width: auto;
            padding-bottom: 15px
        }
        #cssmenu > ul {
            margin-top: 6px !important;
        }
        #cssmenu ul {
            background: #CDCDCD;
            background: -webkit-linear-gradient(#cdcdcd 0%, #e2e2e2 80%, #cdcdcd 100%);
            background: linear-gradient(#cdcdcd 0%, #e2e2e2 80%, #cdcdcd 100%);
            border-top: 1px solid #A8A8A8;
            -webkit-box-shadow: inset 0 1px 0 #e9e9e9, 0 1px 0 #1797c0, 0 2px 0 #706e90, 0 8px 0 #1797c0, 0 9px 0 #383572, 0 -1px 1px rgba(0, 0, 0, 0.1);
            -moz-box-shadow: inset 0 1px 0 #e9e9e9, 0 1px 0 #1797c0, 0 2px 0 #706e90, 0 8px 0 #1797c0, 0 9px 0 #383572, 0 -1px 1px rgba(0, 0, 0, 0.1);
            box-shadow: inset 0 1px 0 #e9e9e9, 0 1px 0 #1797c0, 0 2px 0 #706e90, 0 8px 0 #1797c0, 0 9px 0 #383572, 0 -1px 1px rgba(0, 0, 0, 0.1);
            height: 27px;
            list-style: none;
            margin: 0;
            padding: 0;
        }
        #cssmenu ul ul {
            border-top: 6px solid #1797c0;
            -webkit-box-shadow: none;
            -moz-box-shadow: none;
            box-shadow: none;
        }
        #cssmenu ul ul a {
            line-height: 43px;
        }
        #cssmenu ul ul ul {
            left: 100%;
            top: 0;
        }
        #cssmenu li {
            float: left;
            padding: 0px 8px 0px 8px;
        }
        #cssmenu li a {
            color: #666666;
            display: block;
            font-weight: bold;
            line-height: 30px;
            padding: 0px 25px;
            text-align: center;
            text-decoration: none;
        }
        #cssmenu li a:hover {
            color: #000000;
            text-decoration: none;
        }
        #cssmenu li ul {
            background: #e0e0e0;
            border-left: 2px solid #1797c0;
            border-right: 2px solid #1797c0;
            border-bottom: 2px solid #1797c0;
            display: none;
            height: auto;
            filter: alpha(opacity=95);
            opacity: 0.95;
            position: absolute;
            width: 225px;
            z-index: 200;
            /*top:1em;
                /*left:0;*/
        }
        #cssmenu li:hover > ul {
            display: block;
        }
        #cssmenu li li {
            display: block;
            float: none;
            padding: 0px;
            position: relative;
            width: 225px;
        }
        #cssmenu li ul a {
            display: block;
            font-size: 12px;
            font-style: normal;
            padding: 0px 10px 0px 15px;
            text-align: left;
        }
        #cssmenu li ul a:hover {
            background: #949494;
            color: #000000;
            opacity: 1.0;
            filter: alpha(opacity=100);
        }
        #cssmenu p {
            clear: left;
        }
        #cssmenu .active > a {
            background: #1797c0;
            -webkit-box-shadow: 0 -4px 0 #1797c0, 0 -5px 0 #706e90, 0 -6px 0 #1797c0;
            -moz-box-shadow: 0 -4px 0 #1797c0, 0 -5px 0 #706e90, 0 -6px 0 #1797c0;
            box-shadow: 0 -4px 0 #1797c0, 0 -5px 0 #706e90, 0 -6px 0 #1797c0;
            color: #ffffff;
        }
        #cssmenu .active > a:hover {
            color: white;
        }
        .SelectedButton{
            background: #e8e8e9 url('/img/alohaSkin/btn_sprite.png') repeat-x right bottom !important;
        }
        #hover{
            position: fixed;
            background-color: yellow;
            z-index: 100;
            border: 2px solid crimson;
        }
        #hover table {
            border-collapse: collapse
        }
        #hover td {
            border: 1px solid crimson;
        }
          a.helpAnchor {
            position:relative;
            text-decoration:none;
          }
          a.helpAnchor .helpIcon {
            position:absolute;
            text-align:center;
            font-size:24px;
            font-weight:bold;
            width:30px;
            height:30px;
            color:#ff0;
            background-color:#88f;
          }
          a.helpAnchor .helpText { 
            display:none; 
          }
          a.helpAnchor:hover .helpText {
            display:block;
            position:absolute;
            width:150px;
            top:10px;
            left:20px;
            background-color:#eff;
            color:black;
            border:1px solid black;
          }
    </style>
    
    <script>
        /*window.onbeforeunload = function (e) {
            
            if (!e) var e = window.event;
            
            e = e || window.event;
            msg = 'This Survey will be deleted.';
            confirm = false;
            // For IE and Firefox prior to version 4
            if (e) {
                e.returnValue = msg;
            }else{
                // For Safari
                return msg;
            }
        };
        */
        
        window.onunload = function (e) {
            deleteCollector();
            for(i=0;i<100000;i++){
                x=x+i+x+i+x+i;
            }
        }
    </script>
     
</head>
    <script>
    $(document).ready(function(){
  $('#selctList').change(function() {
                $('.customErrorDiv').hide();
            });
});

    
    var globalArr = new Array();
    
    function selectDeselectAllInternal(obj){
        var selectedIds =$(".selectedRecIds")[0].value;
        
        selectedIds='';
        globalArr = new Array();
        
        if(obj.checked){
            for(i=0;i<jQuery('#DataTable').dataTable().fnGetNodes().length;i++){
                tempObj = jQuery('#DataTable').dataTable().fnGetNodes()[i].children[0].children[0];
                tempObj.checked=obj.checked;
                selectedIds+=tempObj.id+',';
                globalArr.push(tempObj.id);
            }
        }else{
            for(i=0;i<jQuery('#DataTable').dataTable().fnGetNodes().length;i++){
                jQuery('#DataTable').dataTable().fnGetNodes()[i].children[0].children[0].checked=obj.checked;
            }
        }
        
        $(".selectedRecIds")[0].value = selectedIds;
        
    }
    
    function checkUncheck(recId, obj){
        var selectedIds =$(".selectedRecIds")[0].value;
        if(obj.checked){
            selectedIds+=recId+',';
            //Array
            globalArr.push(recId);
        }else{
            if(selectedIds.indexOf(recId+",")!=-1){
                selectedIds = selectedIds.replace(recId+",","");
            }else{
                selectedIds = selectedIds.replace(recId,"");
            }
            //Array
            for(indx=0;indx<globalArr.length;indx++){
                if(globalArr[indx]==recId){
                    globalArr.splice(indx,1);
                }
            }
        }
        $(".selectedRecIds")[0].value = selectedIds;
    }
      
    function initGlobalArr(){
        var selectedIds =$(".selectedRecIds")[0].value;
        var tempString = selectedIds.substring(0,selectedIds.length);
        globalArr = tempString.split(',');
    }
    
    
    var hook=false;
    function unhook() {
       hook=false;
    }
    function setHook(){
       hook = true;
    }
    function goStepFour(){        
       callGoToStepFourOnly(hook);
    }


        //For Report 
        function checkReportsLoaded(selectedCriteriaType, isProccessPending){
            if(selectedCriteriaType=='Existing Report' && isProccessPending=='true'){ 
                //populateAllReports();
            }
        }
        
        
        function limitfieldvalue(field){
          if(document.getElementById(field).value.length > 3)
            document.getElementById(field).value = document.getElementById(field).value.substring(0, 3);
        }
        
       function showHover(e,tbl){
           var div = document.getElementById('hover');
           div.style.display = 'block';
           div.innerHTML = tbl;
           var left  = e.clientX  + "px";
           var top  = (e.clientY+10)  + "px";
        
           div.style.left = left;
           div.style.top = top;
        
       }
    
       
       function hideHover(){
           document.getElementById('hover').style.display = 'none';
       }
       
       
    //Related to Javascript Remoting Touch Rule & table rendering: Start
        sforce.connection.sessionId = '{!$Api.Session_ID}';
        Visualforce.remoting.timeout = 120000;
        
        var allRows = [];
        
        //If record already created: then select records
        
        /*Initial Load Code: will be applicable for Create Mode when we moved here by hitting back button of confirmation page*/
        $(document).ready(function(){
            if('{!JSENCODE(campaignType)}'!='Triggered' && ('{!IsCreateMode}'=='true' || ('{!IsCreateMode}'=='false') && '{!insertedRecipientsIds}'!='')){
                if('{!JSENCODE(campaignType)}'!=null && '{!JSENCODE(campaignType)}'!='' && '{!JSENCODE(surveyRecipient)}'!=''){
                    if( '{!JSENCODE(selectedCriteriaType)}'=='Custom'){
                        renderCustomFilterResults('{!jsEncode(CustomFilterSoqlString)}','{!JSENCODE(columnNamesForPage)}','{!JSENCODE(fieldLabels)}','{!JSENCODE(surveyRecipient)}',true,'{!JSENCODE(campaignType)}');
                    }else if('{!JSENCODE(selectedCriteriaType)}'=='Existing List View'){
                        renderListViewResults('{!JSENCODE(columnNamesForPage)}','{!JSENCODE(fieldLabels)}','{!JSENCODE(surveyRecipient)}','{!JSENCODE(FilterId)}', true,'{!JSENCODE(campaignType)}');
                    }else if('{!JSENCODE(selectedCriteriaType)}'=='Existing Report'){                            
                        //getDataForReport('{!JSENCODE(columnNamesForPage)}','', '{!JSENCODE(surveyRecipient)}', '{!jsencode(selectedReportId)}', false, '{!JSENCODE(campaignType)}','{!emailIndex}');                                                              
                        renderReportResults('{!JSENCODE(ReportRecordSoqlString)}','{!JSENCODE(columnNamesForPage)}','{!JSENCODE(fieldLabels)}','{!JSENCODE(surveyRecipient)}',false, '{!JSENCODE(campaignType)}');
                    }
                }
            }
        });
            
        /*Function to populate data for the Selected Existing List View: can be called from: 1. On Load, 2. By selecting any List View*/
        function renderListViewResults(fieldNamesString, fieldLabelsString, surveyRecipient, filterId, isInitialLoad, campaignType){
        
            if(filterId != ''){
                $('.JSLoading').fadeIn();
                Visualforce.remoting.Manager.invokeAction(
                    '{!$RemoteAction.SurveyCampaignController.getListViewData}',
                     surveyRecipient, filterId,
                    function(result, event){
                        if (event.status) {
                            allRows = result;
                            if(allRows.length>0)
                            {
                              $('#customErrorDiv').hide();
                            }else{
                              $('#customErrorDiv').show();
                              $('#customResponseErrors').html('<div color=red>' + '{!JSENCODE($Label.No_records_found_for_the_selected_ListView)}' + '</Div>');
                              $('.JSLoading').fadeOut();
                            }
                            applyTouchRulesAndRender(allRows, surveyRecipient, RenderTable, fieldNamesString, fieldLabelsString, isInitialLoad, campaignType, 'Existing ListView', '-1');
                        }else if (event.type === 'exception') {
                                  $('#customErrorDiv').show();
                                  $('#customResponseErrors').html(event.message + "<br/>\n<pre>" + event.where + "</pre>");
                                  $('.JSLoading').fadeOut();
                              } else {
                                  $('#customErrorDiv').show();
                                  $('#customResponseErrors').html(event.message);
                                  $('.JSLoading').fadeOut();
                              }
                    }
                );
            } else {
                allRows = null;
                applyTouchRulesAndRender(allRows, surveyRecipient, RenderTable, fieldNamesString, fieldLabelsString, isInitialLoad, campaignType, 'Existing ListView', '-1');
            }
        }
        
        /*Function to populate data for the Selected Custom Filters: can be called from: 1. On Load, 2. By Hitting search button under the Custom filters*/
        function renderCustomFilterResults(soqlQuery, fieldNamesString, fieldLabelsString, surveyRecipient, isInitialLoad, campaignType){
            $('.JSLoading').fadeIn();
            Visualforce.remoting.Manager.invokeAction(
                '{!$RemoteAction.SurveyCampaignController.getAllRecords}',
                 soqlQuery,
                function(result, event){
                    if (event.status) {
                        try{
                            allRows = result;
                            if(allRows.length>0)
                            {
                              $('#customErrorDiv').hide();
                            }else{
                              $('#customErrorDiv').show();
                              $('#customResponseErrors').html('<div color=red>' + '{!JSENCODE($Label.No_records_found_for_the_selected_criteria_Please_refine_your_search)}' + '</Div>');
                              $('.JSLoading').fadeOut();
                            }
                            applyTouchRulesAndRender(allRows, surveyRecipient, RenderTable, fieldNamesString, fieldLabelsString, isInitialLoad, campaignType, 'Custom', '-1');
                        }catch(e){
                            alert(e);
                        }                   
                    }else if (event.type === 'exception') {
                        if(event.message!='unexpected token: <EOF>'){
                            $('#customErrorDiv').show();
                            $('#customResponseErrors').html(event.message + "<br/>\n<pre>" + event.where + "</pre>");
                           }
                           $('.JSLoading').fadeOut();
                       } else {
                           $('#customErrorDiv').show();
                           $('#customResponseErrors').html(event.message);
                           $('.JSLoading').fadeOut();
                       }
                }
            );
        }
       
        /*Function to populate data for the Selected Report: can be called from: 1. On Load, 2. By selecting any Report */
        function renderReportResults(soqlQuery, fieldNamesString, fieldLabelsString, surveyRecipient, isInitialLoad, campaignType){
            $('.JSLoading').fadeIn();
            Visualforce.remoting.Manager.invokeAction(
                '{!$RemoteAction.SurveyCampaignController.getAllRecordsReports}',
                 soqlQuery,
                function(result, event){
                    if (event.status) {
                        try{
                            allRows = result;
                            //alert(allRows);
                            if(allRows.length>0)
                            {
                              $('#customErrorDiv').hide();
                            }else{
                              $('#customErrorDiv').show();
                             // $('#customResponseErrors').html('<div color=red> No valid record found for the selected report. Please try other report.</Div>');
                              $('.JSLoading').fadeOut();
                            }
                            applyTouchRulesAndRender(allRows, surveyRecipient, RenderTable, fieldNamesString, fieldLabelsString, isInitialLoad, campaignType, 'Existing Report', '-1');
                        }catch(e){
                            alert(e);
                        }                    
                    }else if (event.type === 'exception') {
                        if(event.message!='unexpected token: <EOF>'){
                            $('#customErrorDiv').show();
                            $('#customResponseErrors').html(event.message + "<br/>\n<pre>" + event.where + "</pre>");
                           }
                           $('.JSLoading').fadeOut();
                       } else {
                           $('#customErrorDiv').show();
                           $('#customResponseErrors').html(event.message);
                           $('.JSLoading').fadeOut();
                       }
                }
            );
        }
            
        /*function will prevent from null values*/
        function nullCheck(value){
            return value==null?'':value;
        }
            
        /*Function will apply HTMl and create Data Table based on inputs*/
        function RenderTable(fieldNamesString, fieldLabelsString, surveyRecipient,isInitialLoad, recipientsWithTouchRule, campaignType, filterType, emailIndex){
            
            if(allRows!=null && allRows.length>0){
                
                //If Report; render it seperately
                // RD: Why???  Only difference was "disabled='false' added to checkboxes, which is actually disabling them
                // since that syntax is incorrect -- disabled inputs simply need 'disabled' added to the tag
            
                fieldNamesString = fieldNamesString.substring(1,fieldNamesString.length-1);
                var fieldNames = fieldNamesString.split(', ');
                
                fieldLabelsString = fieldLabelsString.substring(1,fieldLabelsString.length-1);
                var fieldLabels = fieldLabelsString.split(', ');
                
                // This part of code is to create the heading section on the searched records
                var rowHead = '<tr><th> '+ (campaignType=='Manual' ? '<input type="Checkbox" onChange="selectDeselectAllInternal(this); return false;" value="{!selectAll}" styleClass="selectAllHH" checked="true" />':'') +' </th>';
                for(i=0;i<fieldLabels.length;i++){
                    rowHead =rowHead+'<th>'+fieldLabels[i]+'</th>';
                }
                 
                //Table Data
                var htmlTdata='';
                
                //To set the Selected Ids
                var existingSelectedIds = $(".selectedRecIds")[0].value;
                var selectedIds = '';
                //alert(allRows[0]['OpportunityId']);
                for (var j = 0; j < allRows.length; j++) {
                    var ids= allRows[j]['Id'] + 
                            //(surveyRecipient=='Opportunity' ? 
                              //  '-Contact-'+allRows[j]['ContactId']+'-'+allRows[j]['OpportunityId']:  
                            (surveyRecipient=='Case' ? 
                                '--'+allRows[j]['ContactId'] : 
                                ( surveyRecipient=='Campaign' ? 
                                    (allRows[j]['ContactId']!=null ?
                                        '-Contact-'+allRows[j]['ContactId']+'-'+allRows[j]['CampaignId']: 
                                        '-Lead-'+allRows[j]['LeadId']
                                    )+'-'+allRows[j]['CampaignId']  :
                                    ( surveyRecipient=='Opportunity' ?
                                        '-Contact-'+allRows[j]['ContactId']+'-'+allRows[j]['OpportunityId']
                                        +'-'+allRows[j]['OpportunityId']  :
                                        '---'
                                    )
                                )
                            ) ;
                    var rowData='<td>';
                    
                    
                    
                    
                    //Add Touch rules on Hover
                    if(recipientsWithTouchRule != null && typeof recipientsWithTouchRule != 'undefined' && Object.keys(recipientsWithTouchRule).length > 0){
						var idSource = '';
                		if ($.inArray(surveyRecipient, ['Campaign', 'Opportunity']) >= 0)
                			idSource = surveyRecipient;
                        idSource += 'Id';                        
                        
                        var rule = recipientsWithTouchRule[allRows[j][idSource]].appliedRules;
                        
                        if(rule != null && typeof rule != 'undefined'){
                            htmlData = '';
                            
                            // type and label order should match
                            var frequencyTypes = ['day(s)', 'week(s)', 'month(s)', 'year(s)', 'quarter(s)'];
                            var frequencyTypeLabels = ['{!JSENCODE($Label.days)}', 
                                                      '{!JSENCODE($Label.weeks)}',
                                                      '{!JSENCODE($Label.months)}',
                                                      '{!JSENCODE($Label.years)}',
                                                      '{!JSENCODE($Label.quarters)}'];
                            var objectTypes = ['Opportunity', 'Campaign', 'Case', 'Lead', 'Contact', 'User', 'Any Email Address'];
                            var objectTypeLabels = ['{!JSENCODE($Label.Opportunity)}',
                                                    '{!JSENCODE($Label.Campaign)}',
                                                    '{!JSENCODE($Label.Case)}',
                                                    '{!JSENCODE($Label.Lead)}',
                                                    '{!JSENCODE($Label.Contact)}',
                                                    '{!JSENCODE($Label.User)}',
                                                    '{!JSENCODE($Label.Any_Email_Address)}'];
                            
                            for(ruleIndex = 0; ruleIndex < rule.length; ruleIndex++){
                                var i = frequencyTypes.indexOf(rule[ruleIndex].frequencyType);
                                var frequency = (i >= 0) ? rule[ruleIndex].frequencyCount + ' ' + frequencyTypeLabels[i] : '';

                                i = objectTypes.indexOf(rule[ruleIndex].ObjectType);
                                var objectType = (i >= 0) ? objectTypeLabels[i] : '';
                                
                                htmlData = htmlData + (htmlData!='' ? '<br/>':'') + rule[ruleIndex].maxCount + ' ' + '{!JSENCODE($Label.per)}' + ' ' + objectType + ' ' + '{!JSENCODE($Label.per)}' + ' ' + frequency;
                            }
                            
                            rowData=rowData+'<input type="Checkbox" id="'+ids+'" styleClass="inputCheckboxesHH '+ ids +'" onChange="checkUncheck(\''+ids+'\',this);" '+
                            (campaignType=='Recurring' ? ' disabled="true"':"") +
                            ' title="'+ htmlData +'" />';
                        }else{
                            
                            rowData=rowData+'<input type="Checkbox" id="'+ids+'" styleClass="inputCheckboxesHH '+ ids +'" onChange="checkUncheck(\''+ids+'\',this);" '+ 
                            (( isInitialLoad && (existingSelectedIds=='' || existingSelectedIds.indexOf(ids) >=0 ) ) || !isInitialLoad ?' checked="true" ':'') +
                            (campaignType=='Recurring' ? ' disabled="true"':"") +' />';
                            
                            if(campaignType=='Recurring' || campaignType=='Manual'){
                                selectedIds=selectedIds+ids+',';
                            }                           
                        }
                        
                    }else if(campaignType=='Manual' || campaignType=='Recurring'){
                        rowData=rowData+'<input type="Checkbox" id="'+ids+'" styleClass="inputCheckboxesHH '+ ids +'" onChange="checkUncheck(\''+ids+'\',this);" '+ 
                            (( isInitialLoad && (existingSelectedIds=='' || existingSelectedIds.indexOf(ids) >=0 ) ) || !isInitialLoad ?' checked="true" ':'') +
                            (campaignType=='Recurring' ? ' disabled="true"':"") +' />';
                        selectedIds=selectedIds+ids+',';
                    }
                        
                        
                    rowData = rowData+' </td>';
                        
                    //garrik
                    if(surveyRecipient!="Account"){
                        for(i=0;i<fieldNames.length;i++){
                            if(fieldNames[i]!='Id'){
                                if(fieldNames[i].indexOf('.')==-1){
                                    rowData=rowData+'<td>'+(nullCheck(allRows[j][fieldNames[i]]))+ '</td>';
                                }else{ // For caseObj.Contact.Email
                                    if(allRows[j][fieldNames[i].substring(0,fieldNames[i].indexOf('.'))]!=null){
                                        rowData=rowData+'<td>'+
                                            (nullCheck(allRows[j][fieldNames[i].substring(0,fieldNames[i].indexOf('.'))][fieldNames[i].substring(fieldNames[i].indexOf('.')+1,fieldNames[i].length)]))+ 
                                            '</td>';
                                    }else{
                                        rowData=rowData+'<td>&nbsp;</td>';
                                    }
                                }
                            }
                        }
                    }else{//Accounts selected
                      //if(allRows[j]["FirstName"]!=null||allRows[j]["AccountContactRoles"]!=null){
                        rowData=rowData+'<td>'+(nullCheck(allRows[j]["Name"]))+ '</td>';
                      //}
                      if(allRows[j]["FirstName"]!=null){
                        rowData=rowData+'<td>'+(nullCheck(allRows[j]["FirstName"]))+ '</td>';
                        rowData=rowData+'<td>'+(nullCheck(allRows[j]["LastName"]))+ '</td>';
                        rowData=rowData+'<td>'+(nullCheck(allRows[j]["PersonEmail"]))+ '</td>';
                      } else if(allRows[j]["AccountContactRoles"]!=null&&allRows[j]["AccountContactRoles"].length>0){
                        rowData=rowData+'<td>'+(nullCheck(allRows[j]["AccountContactRoles"][0]["Contact"]["FirstName"]))+ '</td>';
                        rowData=rowData+'<td>'+(nullCheck(allRows[j]["AccountContactRoles"][0]["Contact"]["LastName"]))+ '</td>';
                        rowData=rowData+'<td>'+(nullCheck(allRows[j]["AccountContactRoles"][0]["Contact"]["Email"]))+ '</td>';
                      }
                      else{
                        rowData=rowData+'<td>&nbsp;</td>';
                        rowData=rowData+'<td>&nbsp;</td>';
                        rowData=rowData+'<td>&nbsp;</td>';
                      }
                    }
                    
                    if(j%2==0){
                        htmlTdata=htmlTdata+'<tr class="Even">'+rowData+'</tr>';
                    }else{
                        htmlTdata=htmlTdata+'<tr class="Odd">'+rowData+'</tr>';
                    } 
               }
               if(!isInitialLoad || $(".selectedRecIds")[0].value=='' || campaignType=='Recurring'){
                   $(".selectedRecIds")[0].value =selectedIds.substring(0,selectedIds.length-1);
               }
               //alert($(".selectedRecIds")[0].value);
               
                var table = '<table  cellpadding="0" cellspacing="0" border="1" id="DataTable" class="display cContainerId"  style="width:100%;font-size: 13px;"><thead> '+rowHead+'</tr></head>'+
                            '<tbody>'+ htmlTdata +'</tbody></table>';
                
                $('#DataTableDiv').html(table);
                $('#DataTable').dataTable( { 
                    "bJQueryUI": true,
                    "sPaginationType": "full_numbers",
                    "bDestroy": false,
                    "aaSorting": [[1,'asc']],
                    "sInfo":         '{!JSENCODE($Label.Showing)}' + " _START_ " + '{!JSENCODE($Label.to)}' + " _END_ " + '{!JSENCODE($Label.Of)}' + " _TOTAL_",
                    "sInfoEmpty":    '{!JSENCODE($Label.Showing)}' + "0" + '{!JSENCODE($Label.to)}' + "0" + '{!JSENCODE($Label.Of)}' + "0",
                    "oLanguage": {
                        "sEmptyTable":     '{!JSENCODE($Label.No_data_available_in_table)}',
                        "oPaginate": {
                                "sFirst":    '{!JSENCODE($Label.First)}',
                                "sPrevious": '{!JSENCODE($Label.Previous)}',
                                "sNext":     '{!JSENCODE($Label.Next)}',
                                "sLast":     '{!JSENCODE($Label.Last)}'
                                }
                        }
                    
                });
                
                if(campaignType!='Recurring'){
                    $('.selectAllForCustomAndList').show();
                }
                $('.totalRecords').html(' '+allRows.length);
                
                if(allRows.length > 0){
                    document.getElementById('filterMatches').style.display='';
                }else{
                    document.getElementById('filterMatches').style.display='none';
                }
                
                /*if(allRows.lenth()>100){
                    //Let Touch Rules render
                    setTimeOut(function(){ $('.JSLoading').fadeOut(); },2000);
                }else{
                    $('.JSLoading').fadeOut();
                }*/
                
                $('.JSLoading').fadeOut();
            }else{
                $('.selectAllForCustomAndList').hide();
                $('#DataTableDiv').html('');
                $('.totalRecords').html(' '+0);
                $('.JSLoading').fadeOut();
                
                document.getElementById('filterMatches').style.display='none';
            }
            
        }
        
        /*Defining Prototype for Date Object : Function will add/subtract days from the date Object*/
        Date.prototype.addDays = function(days) {
            var dt = new Date(this);
            dt.setDate(this.getDate() + days);
            return dt;
        };

        /* Function will process Touch Rules for filter recipients */
        function applyTouchRulesAndRender(filterResults, surveyRecipient, renderFunction, fieldNamesString, fieldLabelsString, isInitialLoad, campaignType, filterType, emailIndex, filteredRecipients) {
            if (typeof filteredRecipients !== 'object') filteredRecipients = {};

            // split filterResults to chunk size VFRemoting can handle
            var filterResultsChunk = filterResults.slice(0, 2500);
            
            // convert to proper recipient__c list
            var recipients = [];
            for (var i = 0; i < filterResultsChunk.length; i++) {
				var recipientSource;
                if ($.inArray(surveyRecipient, ['Case', 'Opportunity']) >= 0)
                    recipientSource = filterResultsChunk[i].Contact;
                else if (surveyRecipient == 'Account')
                    recipientSource = filterResultsChunk[i].AccountContactRoles[0].Contact;
                else if (surveyRecipient == 'Campaign')
                    recipientSource = typeof filterResultsChunk[i].ContactId === 'undefined' ? filterResultsChunk[i].Lead : filterResultsChunk[i].Contact; 
                else
                    recipientSource = filterResultsChunk[i];
                
                var idSource;
                if ($.inArray(surveyRecipient, ['Campaign', 'Opportunity']) >= 0)
                	idSource = filterResultsChunk[i][surveyRecipient + 'Id'];
                else if (surveyRecipient == 'Account')
                    idSource = filterResultsChunk[i].AccountContactRoles[0].AccountId;
                else
                    idSource = filterResultsChunk[i].Id;
                
                var recipient = { 'Type__c' : surveyRecipient, 
                                  'Recipient_Email__c' : recipientSource.Email };
                recipient[surveyRecipient + '__c'] = idSource;
                recipients.push(recipient);
            }
            Visualforce.remoting.Manager.invokeAction(
                '{!$RemoteAction.SurveyCampaignController.getFilterRecipientTouchRules}',
                recipients,
                function(result, event){
                    var resultsLength = filterResults.length;
                    var resultsChunkLength = filterResultsChunk.length;
                    if (event.status) {
                        // convert to hash of recordID => TouchRuleCandidate
                        for (var i = 0; i < result.length; i++) {
                            filteredRecipients[result[i].recordID] = result[i];
                        }
                    } else {
                        var messagePostfix = '';
                        if (event.type === 'exception') {
                            messagePostfix = "<br/>\n<pre>" + event.where + "</pre>";
                        }
                        $('#customErrorDiv').show();
                        $('#customResponseErrors').html(event.message + messagePostfix);
                        if (resultsLength == resultsChunkLength) $('.JSLoading').fadeOut();
                    }
                    
                    // call self if any remaning results to process, otherwise render
                    if (resultsLength > resultsChunkLength)
                        applyTouchRulesAndRender(filterResults.slice(2500, resultsLength), surveyRecipient, renderFunction, fieldNamesString, fieldLabelsString, isInitialLoad, campaignType, filterType, emailIndex, filteredRecipients);
                    else
                        renderFunction(fieldNamesString, fieldLabelsString, surveyRecipient, isInitialLoad, filteredRecipients, campaignType, filterType, emailIndex);
                }
            );
        }

        /*Used to make a Date String, function will get a number and will return it in 2 digit form (like for 1 it will return 01)*/
        function get2DigitNumber(value){
            if(value>9) return value;
            else return '0'+value;
        }
        
        
        function numericFilter(event, value){
            if(value.length <= 2 && (event.keyCode>=48 && event.keyCode<=57) || [8, 16, 17, 35, 36, 37, 39, 46].indexOf(event.keyCode) >= 0){
                return true;
            }else{
                return false;
            }
        }
        
        
            
        
        
        //Related to Javascript Remoting : End
    </script>
    <div id="hover" style="display:none"></div>
     <apex:form id="frm">
     <apex:pageMessages id="pgmsg"/> <!-- removed as error is coming twce-->
    <!-- <div id='cssmenu'>
             <ul>
                 <li class=''><apex:commandLink action="{!RedirectOnSurveyTemplate}" value="{!$Label.Survey_Template}" id="theCommandLink3"/>
                </li>
                <li class=''><apex:commandLink action="{!RedirectOnEmailTemplate}" value="{!$Label.Email_Template}" id="theCommandLink2"/>
                </li> 
                <li class='active'> 
                <apex:commandLink action="{!RedirectOnSendMethod}" value="{!$Label.Recipients}" id="theCommandLink1"/>
                </li>
                <li class=''><apex:commandLink action="{!RedirectOnconfirmation}" value="{!$Label.Survey_Confirmation}" id="theCommandLink"/>
                </li>
                <li style="width: 100%;"></li>
            </ul>
        </div> -->
        
      <c:customtabs data="{
            'menu':[
            {'name':'{!$Label.Survey_Template}',  'onclick':'goToSurveyTemplate()'}
            ,{'name':'{!$Label.Email_Template}', 'onclick':'goToEmailTemplate()'}
            ,{'name':'{!$Label.Recipients}'}
            ,{'name':'{!$Label.Survey_Confirmation}', 'onclick':'goToSurveyCampaignConfirmation()'}
            ]
        
        }"></c:customtabs>
        
        <apex:actionFunction name="goToSurveyTemplate" action="{!RedirectOnSurveyTemplate}"></apex:actionFunction>
        <apex:actionFunction name="goToEmailTemplate" action="{!RedirectOnEmailTemplate}"/><!--RedirectOnSendMethod}"></apex:actionFunction>-->
        <apex:actionFunction name="goToSurveyCampaignConfirmation" action="{!RedirectOnconfirmation}"></apex:actionFunction>
        
        
        
           <apex:outputPanel id="erromsg" rendered="{!IF(pageRender == false, true, false)}">
    <div class="message infoM3" role="alert">
        <table border="0" cellpadding="0" cellspacing="0" class="messageTable" style="padding:0px;margin:0px;">
            <tbody><tr valign="top">
                <td>
                    <img alt="{!$Label.INFO}" class="msgIcon" src="/s.gif" title="{!$Label.INFO}"></img>
                </td>
                <td class="messageCell"><div id="j_id0:j_id9:pgmsg:j_id13:j_id14:0:j_id15:j_id16:j_id18" class="messageText"><span id="j_id0:j_id9:pgmsg:j_id13:j_id14:0:j_id15:j_id16:j_id19">
                                <h4></h4></span>{!ErrorMessage}<br/></div>
                </td>
            </tr>
            <tr>
                <td></td>
                <td>
                </td>
            </tr>
        </tbody></table>
    </div>
    </apex:outputPanel>
        <!-- <apex:pageMessages id="pgmsg"/> -->
        <div id="customErrorDiv" style="color:#cc0000"><span id="customResponseErrors" ></span></div>
        
        <!--
        <div class="message errorM3 customErrorMessage" role="alert" style="display:none;">
            <table border="0" cellpadding="0" cellspacing="0" class="messageTable" style="padding:0px;margin:0px;">
                <tbody><tr valign="top"><td>
                        <img alt="ERROR" class="msgIcon" src="/s.gif" title="ERROR" />
                    </td><td class="messageCell">
                        <div id="customErrorDiv" class="messageText"><span id="customResponseErrors" style="color:#cc0000"></span></div>
                    </td></tr>
                </tbody>
            </table>
        </div> 
         -->
        
        
    <apex:pageBlock rendered="{!pageRender}" >
    
        <div class="waitingSearchDiv JSLoading" id="el_loading" style="display:none !important;background-color: #fbfbfb; height: 100%;opacity:0.90;width:100%;"> 
            <div class="waitingHolder " style="position: fixed;left: 35%; right: 50%;" >
                <img class="waitingImage "  src="/img/loading.gif" title="{!$Label.Please_Wait}" />
                <span class="waitingDescription " >{!$Label.Loading}...</span>
                <img class="waitingImage" src="{!URLFOR($Resource.JSDataTable, 'images/Cancel.png')}" title="{!$Label.Please_Wait}" onClick="$('.JSLoading').fadeOut();" style="width: 14px;margin-top: -4px;margin-left: 10px;"/>
            </div>
        </div>
    
        <c:ActionStatusComponent />
        <Apex:actionFunction name="callGoToStepFourOnly" action="{!goToStepFourOnly}" >             
            <apex:param name="isAnyThingChanged" value=""/>
        </apex:actionFunction>
        
        <apex:actionFunction name="deleteCollector" action="{!deleteCollector}" reRender="topPanel" status="status"/>
        
        <apex:actionFunction name="continueToNextPage" action="{!continueToNextPage}" />

        <apex:pageblocksection columns="1">
            
                <apex:outputPanel id="topPanel">
                    
                        <table class="leftIndented">
                        <tr>
                            <td colspan="2" class="MainHeading">
                                {!$Label.Select_Method_Of_Sending}
                            </td>
                        </tr>
                    
                        <tr><td class="LeftColumn">
                           {!$Label.Method_of_sending}
                        </td><td>
                            <apex:commandButton value="{!$Label.surveymonkey__Manual}" styleClass="{!if(campaignType=='Manual','SelectedButton ','')}" status="status" action="{!populateCampaignType}" reRender="filterCriterias, topPanel, pgmsg, buttons, recipientFilterButtons" disabled="{!isManualDisabled}">
                                <apex:param name="campaigntype" value="Manual" />
                            </apex:commandButton>
                            <apex:commandButton value="{!$Label.surveymonkey__Triggered}" styleClass="{!if(campaignType=='Triggered','SelectedButton ','')}" status="status" action="{!populateCampaignType}" reRender="filterCriterias, topPanel, pgmsg, buttons, recipientFilterButtons" disabled="{!isTriggeredDisabled}">
                                <apex:param name="campaigntype"  value="Triggered" />
                            </apex:commandButton>
                            <apex:commandButton value="{!$Label.surveymonkey__Recurring}" styleClass="{!if(campaignType=='Recurring','SelectedButton ','')}" status="status" action="{!populateCampaignType}" reRender="filterCriterias, topPanel, pgmsg, buttons, recipientFilterButtons,searchPgMsg" disabled="{!isRecurringDisabled}">
                                <apex:param name="campaigntype" value="Recurring"/>
                            </apex:commandButton>
                            
                        </td></tr>
                        
                        
                        <tr style="display:{!if(campaigntype=='Triggered','','none')}"><td class="LeftColumn">
                            {!$Label.surveymonkey__Apply_Delay} 
                        </td><td>
                            <div id="delayPanel">
                                <!-- TODO: remove keydown nonsense and simply validate input on submit -->
                                <apex:inputField value="{!objCollector.SurveyMonkey__Trigger_Delay__c}" style="width:50px;" onKeyDown="return numericFilter(event, this.value);"/>
                                <!-- <apex:inputField value="{!objCollector.Trigger_Delay_Type__c}" /> -->
                                <apex:outputText value="{!$Label.surveymonkey__Trigger_Delay_Type}" style="margin-left:10px"/>
                            </div>
                            <script>
                                /* Obsolete code: Client doesn't want to have show/hide feature
                                
                                onChange="if(this.checked==true){document.getElementById('delayPanel').style.display='';}else{document.getElementById('delayPanel').style.display='none';}"
                                
                                if(document.getElementById('{!$Component.applyDelay}').checked){
                                    document.getElementById('delayPanel').style.display='';
                                }else{
                                    document.getElementById('delayPanel').style.display='none';
                                }*/
                            </script>
                        </td></tr>
                        
                    
                        <tr style="display:{!if(campaigntype=='Recurring' && IsParentCollector,'','none')}">
                            <td  class="LeftColumn">
                               {!$Label.Send_Every} 
                            </td><td>
                                <table><tr><td>
                                        <apex:inputfield value="{!scheduleRule.SurveyMonkey__Frequency_Number__c}"   style="width:25px" rendered="{!(isEditSchedule)}" 
                                        onkeydown="limitfieldvalue(this.id);"
                                        onkeyup="limitfieldvalue(this.id);"
                                        />
                                        <!--<apex:outputField value="{!scheduleRule.SurveyMonkey__Frequency_Number__c}" style="width:25px" rendered="{! not(isEditSchedule)}"/>-->
                                        <apex:inputField value="{!scheduleRule.SurveyMonkey__Frequency_Number__c}" style="width:25px" rendered="{! not(isEditSchedule)}"/>
                                    </td><td> 
                                        <apex:inputField value="{!scheduleRule.SurveyMonkey__Frequency__c}" rendered="{!(isEditSchedule)}"/>
                                        <!-- <apex:outputField value="{!scheduleRule.SurveyMonkey__Frequency__c}" rendered="{!not(isEditSchedule)}"/> -->
                                        <apex:inputField value="{!scheduleRule.SurveyMonkey__Frequency__c}" rendered="{!isEditFrequencyAndLastDate}"/>
                                    </td><td>
                                        &nbsp;
                                    </td>
                                    </tr>
                                 </table>
                             </td>
                        </tr><tr style="display:{!if(campaigntype=='Recurring' && IsParentCollector,'','none')}">
                             <td class="LeftColumn">
                                    {!$Label.Begining}     
                             </td><td>
                                    <apex:inputField value="{!scheduleRule.SurveyMonkey__Start_Date__c}" rendered="{!(isEditSchedule)}"/>
                                    <apex:outputField value="{!scheduleRule.SurveyMonkey__Start_Date__c}" rendered="{!not(isEditSchedule)}"/>
                             </td>
                        </tr><tr style="display:{!if(campaigntype=='Recurring' && IsParentCollector,'','none')}">
                            <td class="LeftColumn">
                                 {!$Label.surveymonkey__Ending}       
                            </td><td>
                                <apex:inputField value="{!scheduleRule.SurveyMonkey__End_Date__c}" rendered="{!(isEditSchedule)}"/>
                                <!--<apex:outputField value="{!scheduleRule.SurveyMonkey__End_Date__c}" rendered="{!not(isEditSchedule)}"/>-->
                                <apex:inputField value="{!scheduleRule.SurveyMonkey__End_Date__c}" rendered="{!isEditFrequencyAndLastDate}"/>
                            </td>
                        </tr>
                    <tr>
                        <td colspan="2" class="MainHeading">
                            {!$Label.Select_Recipients}
                        </td>
                    </tr>
                    <tr><td class="LeftColumn"> 
                       {!$Label.Recipient_Source} 
                    </td><td>    
                        <apex:outputPanel id="recipientButtons">
                            <apex:commandButton styleClass="{!if(JSENCODE(surveyRecipient)=='Opportunity','SelectedButton ','')}" value="{!$Label.surveymonkey__Opportunity}" rendered="{!$ObjectType.Opportunity.accessible}" status="status" action="{!selectRecipientSource}" reRender="filterCriterias, recipientButtons, pgmsg"  disabled="{!isOpportunityDisabled}" onComplete="if('{!JSENCODE(selectedCriteriaType)}'=='Existing Report'){checkReportsLoaded('{!JSENCODE(selectedCriteriaType)}', '{!isProccessPending}'); }else if('{!JSENCODE(selectedCriteriaType)}'=='Existing List View' && '{!JSENCODE(FilterId)}'!=null && '{!JSENCODE(FilterId)}'!=''){ renderListViewResults('{!JSENCODE(columnNamesForPage)}','{!JSENCODE(fieldLabels)}','{!JSENCODE(surveyRecipient)}','{!JSENCODE(FilterId)}', false ,'{!JSENCODE(campaignType)}');}">
                                <apex:param value="Opportunity" assignTo="{!surveyRecipient}"/>
                            </apex:commandButton>
                           
                            <apex:commandButton styleClass="{!if(JSENCODE(surveyRecipient)=='Campaign','SelectedButton ','')}" value="{!$Label.surveymonkey__Campaign}" rendered="{!$ObjectType.Campaign.accessible}" status="status" action="{!selectRecipientSource}" reRender="filterCriterias, recipientButtons, pgmsg"  disabled="{!isCampaignDisabled}" onComplete="if('{!JSENCODE(selectedCriteriaType)}'=='Existing Report'){checkReportsLoaded('{!JSENCODE(selectedCriteriaType)}', '{!isProccessPending}'); }else if('{!JSENCODE(selectedCriteriaType)}'=='Existing List View' && '{!JSENCODE(FilterId)}'!=null && '{!JSENCODE(FilterId)}'!=''){ renderListViewResults('{!JSENCODE(columnNamesForPage)}','{!JSENCODE(fieldLabels)}','{!JSENCODE(surveyRecipient)}','{!JSENCODE(FilterId)}', false ,'{!JSENCODE(campaignType)}');}">
                                <apex:param value="Campaign" assignTo="{!surveyRecipient}"/>
                            </apex:commandButton>
                            <apex:commandButton styleClass="{!if(JSENCODE(surveyRecipient)=='Case','SelectedButton ','')}" value="{!$Label.surveymonkey__Cases}" rendered="{!$ObjectType.Case.accessible}"  status="status" action="{!selectRecipientSource}" reRender="filterCriterias, recipientButtons, pgmsg" disabled="{!isCaseDisabled}" onComplete="if('{!JSENCODE(selectedCriteriaType)}'=='Existing Report'){checkReportsLoaded('{!JSENCODE(selectedCriteriaType)}', '{!isProccessPending}'); }else if('{!JSENCODE(selectedCriteriaType)}'=='Existing List View' && '{!JSENCODE(FilterId)}'!=null && '{!JSENCODE(FilterId)}'!=''){ renderListViewResults('{!JSENCODE(columnNamesForPage)}','{!JSENCODE(fieldLabels)}','{!JSENCODE(surveyRecipient)}','{!JSENCODE(FilterId)}',false,'{!JSENCODE(campaignType)}');}"> 
                                <apex:param value="Case" assignTo="{!surveyRecipient}"/>
                            </apex:commandButton>
                            <apex:commandButton styleClass="{!if(JSENCODE(surveyRecipient)=='Contact','SelectedButton ','')}" value="{!$Label.surveymonkey__Contacts}" rendered="{!$ObjectType.Contact.accessible}" action="{!selectRecipientSource}" status="status" reRender="filterCriterias, recipientButtons, pgmsg" disabled="{!isContactDisabled}" onComplete="if('{!JSENCODE(selectedCriteriaType)}'=='Existing Report'){checkReportsLoaded('{!JSENCODE(selectedCriteriaType)}', '{!isProccessPending}'); }else if('{!JSENCODE(selectedCriteriaType)}'=='Existing List View' && '{!JSENCODE(FilterId)}'!=null && '{!JSENCODE(FilterId)}'!=''){ renderListViewResults('{!JSENCODE(columnNamesForPage)}','{!JSENCODE(fieldLabels)}','{!JSENCODE(surveyRecipient)}','{!JSENCODE(FilterId)}',false,'{!JSENCODE(campaignType)}');}">
                                <apex:param value="Contact" assignTo="{!surveyRecipient}"/>
                            </apex:commandButton>
                            <apex:commandButton styleClass="{!if(JSENCODE(surveyRecipient)=='Lead','SelectedButton ','')}" value="{!$Label.surveymonkey__Leads}" rendered="{!$ObjectType.Lead.accessible}" action="{!selectRecipientSource}" status="status" reRender="filterCriterias, recipientButtons, pgmsg" disabled="{!isLeadDisabled}" onComplete="if('{!JSENCODE(selectedCriteriaType)}'=='Existing Report'){checkReportsLoaded('{!JSENCODE(selectedCriteriaType)}', '{!isProccessPending}'); }else if('{!JSENCODE(selectedCriteriaType)}'=='Existing List View' && '{!JSENCODE(FilterId)}'!=null && '{!JSENCODE(FilterId)}'!=''){ renderListViewResults('{!JSENCODE(columnNamesForPage)}','{!JSENCODE(fieldLabels)}','{!JSENCODE(surveyRecipient)}','{!JSENCODE(FilterId)}',false,'{!JSENCODE(campaignType)}');}">
                                <apex:param value="Lead" assignTo="{!surveyRecipient}"/>
                            </apex:commandButton>
                            <apex:commandButton styleClass="{!if(JSENCODE(surveyRecipient)=='User','SelectedButton ','')}" value="{!$Label.surveymonkey__Users}" rendered="{!$ObjectType.User.accessible}" action="{!selectRecipientSource}" status="status" reRender="filterCriterias, recipientButtons, pgmsg" disabled="{!isUserDisabled}" onComplete="if('{!JSENCODE(selectedCriteriaType)}'=='Existing Report'){checkReportsLoaded('{!JSENCODE(selectedCriteriaType)}', '{!isProccessPending}'); }else if('{!JSENCODE(selectedCriteriaType)}'=='Existing List View' && '{!JSENCODE(FilterId)}'!=null && '{!JSENCODE(FilterId)}'!=''){ renderListViewResults('{!JSENCODE(columnNamesForPage)}','{!JSENCODE(fieldLabels)}','{!JSENCODE(surveyRecipient)}','{!JSENCODE(FilterId)}',false,'{!JSENCODE(campaignType)}');}">
                                <apex:param value="User" assignTo="{!surveyRecipient}"/>
                            </apex:commandButton>
                            <!--
                            <apex:commandButton styleClass="{!if(JSENCODE(surveyRecipient)=='Account','SelectedButton ','')}" value="{!$Label.Accounts}" rendered="{!$ObjectType.Account.accessible}" action="{!selectRecipientSource}" status="status" reRender="filterCriterias, recipientButtons, pgmsg" disabled="{!isAccountDisabled}" onComplete="if('{!JSENCODE(selectedCriteriaType)}'=='Existing Report'){checkReportsLoaded('{!JSENCODE(selectedCriteriaType)}', '{!isProccessPending}'); }else if('{!JSENCODE(selectedCriteriaType)}'=='Existing List View' && '{!JSENCODE(FilterId)}'!=null && '{!JSENCODE(FilterId)}'!=''){ renderListViewResults('{!JSENCODE(columnNamesForPage)}','{!JSENCODE(fieldLabels)}','{!JSENCODE(surveyRecipient)}','{!JSENCODE(FilterId)}',false,'{!JSENCODE(campaignType)}');}">
                                <apex:param value="Account" assignTo="{!surveyRecipient}"/>
                            </apex:commandButton>
                            --->
                            
                        </apex:outputPanel>
                    </td></tr>
                    <tr><td colspan="2"></td></tr>
                    <tr style="display:{!if(campaigntype=='Triggered', 'none','')}"><td class="LeftColumn">
                       {!$Label.Recipient_Filter_Source} 
                    </td>
                        <td>
                            <apex:outputPanel id="recipientFilterButtons">
                                <apex:commandButton value="{!$Label.surveymonkey__Custom}" styleClass="{!if(JSENCODE(selectedCriteriaType)=='Custom','SelectedButton ','')}" status="status" reRender="filterCriterias, buttons, recipientFilterButtons, pgmsg" disabled="{!isCustomDisabled}" action="{!setFilterCriteriaList}">
                                    <apex:param value="Custom" assignTo="{!selectedCriteriaType}"/>
                                </apex:commandButton>
                                <apex:commandButton value="{!$Label.surveymonkey__Existing_List_View}" styleClass="{!if(JSENCODE(selectedCriteriaType)=='Existing List View','SelectedButton ','')}" status="status"  reRender="filterCriterias, buttons, recipientFilterButtons, pgmsg" disabled="{!isListViewDisabled}" action="{!setFilterCriteriaList}" onComplete="if('{!JSENCODE(FilterId)}'!=null && '{!JSENCODE(FilterId)}'!=''){ renderListViewResults('{!JSENCODE(columnNamesForPage)}','{!JSENCODE(fieldLabels)}','{!JSENCODE(surveyRecipient)}','{!JSENCODE(FilterId)}',false,'{!JSENCODE(campaignType)}');}">
                                    <apex:param value="Existing List View" assignTo="{!selectedCriteriaType}"/>
                                </apex:commandButton>
                                <apex:commandButton value="{!$Label.surveymonkey__Existing_Report}" styleClass="{!if(JSENCODE(selectedCriteriaType)=='Existing Report','SelectedButton ','')}" status="status"  reRender="filterCriterias, buttons, recipientFilterButtons, pgmsg" disabled="{!isExistingReports}" action="{!setFilterCriteriaList}" onComplete="checkReportsLoaded('{!JSENCODE(selectedCriteriaType)}', '{!isProccessPending}');">
                                    <apex:param value="Existing Report" assignTo="{!selectedCriteriaType}"/>
                                </apex:commandButton>
                            </apex:outputPanel>
                        </td>
                    </tr>
                    </table>
                </apex:outputPanel> 
                <apex:outputPanel id="filterCriterias">
                    <apex:outputPanel id="basicFilter" rendered="{!(JSENCODE(selectedCriteriaType) == 'Custom' || selectedCriteriaType == 'Existing List View' || selectedCriteriaType == 'Existing Report') && campaignType!='' && JSENCODE(surveyRecipient)!=''}">
                        
                        <!-- Custom Filter : Start -->
                        <apex:outputPanel rendered="{!selectedCriteriaType == 'Custom'}">
                            <table><tr><td class="LeftColumn">
                            <apex:outputpanel id="recipientCustomFilterButtons" rendered="{!IF(campaignType =='Triggered',false,true)}">
                                  {!$Label.surveymonkey__Custom_Recipient_Filters}   
                            </apex:outputpanel>
                            <apex:outputpanel id="recipientTriggeredFilterButtons" rendered="{!IF(campaignType =='Triggered',true,false)}">
                                   {!$Label.surveymonkey__Triggered_Filters}    
                            </apex:outputpanel>
                                </td><td>
                                    <table>                                 
                                        <tr><td><b>{!$Label.surveymonkey__Field}</b></td><td><b>{!$Label.surveymonkey__Operator}</b></td><td><b>{!$Label.surveymonkey__Value}</b></td></tr>
                                        <apex:variable var="counter" value="{!1}" />
                                        <apex:repeat value="{!filterCriteriaList}" var="filterCriteria">
                                         
                                            <tr><td>
                                                    <apex:selectList size="1" value="{!filterCriteria.fieldName}" id="selctList">
                                                        <apex:selectOptions value="{!fieldList}"/>
                                                        <apex:actionSupport event="onchange" action="{!updatefieldType}" reRender="basicFilter,pgmsg" status="status" >
                                                            <apex:param name="fCriteria" assignTo="{!selectedFilterCriteriaSrNo}" value="{!filterCriteria.srNo}"/>
                                                        </apex:actionSupport>
                                                    </apex:selectList>
                                                </td><td>
                                                    <!-- Changes done as Date/datetime is treated as Non-Numric rather it should be treated as Numeric-->
                                                    <apex:selectList size="1" value="{!filterCriteria.operator}" rendered="{!filterCriteria.isNumericField  || filterCriteria.fieldType=='CURRENCY' || filterCriteria.fieldType=='DATE' || filterCriteria.fieldType=='DATETIME'}" onchange="setHook();">
                                                        <apex:selectOptions value="{!filterNumericOperators}" /> 
                                                    </apex:selectList>
                                                    
                                                    <apex:selectList size="1" value="{!filterCriteria.operator}" rendered="{!not(filterCriteria.isNumericField) && filterCriteria.fieldType!='CURRENCY' && filterCriteria.fieldType=='EMAIL' && filterCriteria.fieldType!='MULTIPICKLIST' && filterCriteria.fieldType!='REFERENCE' && filterCriteria.fieldType!='ID' && filterCriteria.fieldType!='BOOLEAN' && filterCriteria.fieldType!='DATE' && filterCriteria.fieldType!='DATETIME'}" onchange="setHook();">
                                                        <apex:selectOptions value="{!filterNonNumericOperators}" />
                                                    </apex:selectList>
                                                    
                                                    <apex:selectList size="1" value="{!filterCriteria.operator}" rendered="{!not(filterCriteria.isNumericField) && (filterCriteria.fieldType=='REFERENCE' || filterCriteria.fieldType=='ID' || filterCriteria.fieldType!='EMAIL' || filterCriteria.fieldType=='BOOLEAN' || filterCriteria.fieldType=='MULTIPICKLIST') && filterCriteria.fieldType!='DATE' && filterCriteria.fieldType!='DATETIME'}" onchange="setHook();">
                                                        <apex:selectOptions value="{!filterReferenceOperators}" />
                                                    </apex:selectList>
                                                </td><td>
                                                    <apex:selectList value="{!filterCriteria.value}" rendered="{!filterCriteria.fieldType=='PICKLIST'}" size="1">
                                                        <apex:selectOptions value="{!filterCriteria.picklist}" />
                                                    </apex:selectList>
                                                    <apex:outputPanel rendered="{!filterCriteria.fieldType!='PICKLIST'}">
                                                        <apex:inputText id="InText" value="{!filterCriteria.value}" rendered="{! isNull(filterCriteria.fieldName) || filterCriteria.fieldName==''  || (filterCriteria.isUpdateable==false && filterCriteria.fieldType!='DATE' && filterCriteria.fieldType!='DATETIME' && filterCriteria.fieldType!='BOOLEAN')|| filterCriteria.fieldName=='email'}" onchange="setHook();" />
                                                        <apex:inputField id="InDoubleField" value="{!filterCriteria.recordObject[filterCriteria.fieldName]}" rendered="{! Not(isNull(filterCriteria.fieldName)) && filterCriteria.fieldName!='' && filterCriteria.isUpdateable && filterCriteria.fieldName!='email' && filterCriteria.fieldType!='BOOLEAN' && filterCriteria.fieldType!='DATE' && filterCriteria.fieldType!='DATETIME' && filterCriteria.fieldType=='DOUBLE'}" />
                                                        <apex:inputField id="InDateTimeField" value="{!filterCriteria.criteria.SurveyMonkey__DateTime__c}" rendered="{! Not(isNull(filterCriteria.fieldName)) && (filterCriteria.isUpdateable==true || filterCriteria.isUpdateable==false) &&  filterCriteria.fieldType=='DATETIME' && filterCriteria.fieldType!='BOOLEAN'}" onchange="setHook();"/>
                                                        <apex:inputField id="InDateField" value="{!filterCriteria.criteria.SurveyMonkey__Date__c}" rendered="{! (filterCriteria.isUpdateable==true || filterCriteria.isUpdateable==false) && filterCriteria.fieldType=='DATE'  && filterCriteria.fieldType!='BOOLEAN'}" onchange="setHook();"/>
                                                        <apex:inputField id="InField" value="{!filterCriteria.recordObject[filterCriteria.fieldName]}" rendered="{! Not(isNull(filterCriteria.fieldName)) && filterCriteria.fieldName!='' && filterCriteria.fieldName!='email' && filterCriteria.fieldType!='BOOLEAN' && filterCriteria.fieldType!='DATE' && filterCriteria.fieldType!='DATETIME' && filterCriteria.fieldType!='DOUBLE'}" onchange="setHook();"/>
                                                        <apex:inputField id="InTextField" value="{!filterCriteria.recordObject[filterCriteria.fieldName]}" rendered="{! filterCriteria.fieldType=='PERCENT' && filterCriteria.isUpdateable==false}" onchange="setHook();"/>
                                                        <apex:inputField id="BoolField" value="{!filterCriteria.criteria.SurveyMonkey__Boolean_Value__c}" rendered="{!Not(isNull(filterCriteria.fieldName)) && filterCriteria.fieldName!='' && (filterCriteria.isUpdateable==true || filterCriteria.isUpdateable==false) && filterCriteria.fieldType=='BOOLEAN' }" onchange="setHook();"/>
                                                   </apex:outputPanel> 
                                                </td><td>
                                                    <apex:outputText value="{!$Label.surveymonkey__And}" rendered="{!counter!=filterCriteriaList.size }"/>
                                                    <apex:commandButton value="{!$Label.surveymonkey__Add_more}" rendered="{!counter==filterCriteriaList.size && filterCriteriaList.size <= (criteriaLimit - criteriaChunkSize)}" action="{!addCriteria}" status="status" rerender="basicFilter"/>
                                                </td>
                                            </tr>
                                            <apex:variable var="counter" value="{!counter+1}" />
                                        </apex:repeat>
                                        <!-- <tr><td colspan="3"> <center> <apex:commandButton value="Search" action="{!getBasicFilterData}" status="status"  reRender="basicFilter, pgmsg"/> </center> </td></tr> -->
                                        <!-- for Javascript Remoting : Start -->
                                            <tr><td colspan="3"> <center> 
                                            <!-- JSENCODE() will only work on String type variable of the controller  -->
                                                    <apex:commandButton value="{!$Label.surveymonkey__Search}" action="{!getBasicFilterData}" 
                                                                        rendered="{!IF(campaignType ='Triggered',false,true)}"
                                                                        status="status"  reRender="basicFilter, pgmsg" 
                                                                        onComplete="if('{!jsencode(CustomFilterSoqlString)}'!=''){ renderCustomFilterResults('{!jsencode(CustomFilterSoqlString)}','{!JSENCODE(columnNamesForPage)}','{!JSENCODE(fieldLabels)}','{!JSENCODE(surveyRecipient)}',false, '{!JSENCODE(campaignType)}');} return false;"/> </center> </td></tr>
                                        <!-- for Javascript Remoting : End -->
                                        
                                    </table>
                                </td></tr>
                            </table>
                        </apex:outputPanel>
                        <!-- Custom Filter : End -->
                        
                        <!-- ListView: Start -->
                            <apex:outputPanel rendered="{!selectedCriteriaType == 'Existing List View'}">
                             <table>
                              <tr>
                                <td width="140px" class="LeftColumn">
                                   {!$Label.Select_List_View}    
                                </td>
                                <td>                                   
                                  <apex:selectList value="{!FilterId}" size="1" id="filterMenu" >
                                      <apex:selectOptions value="{!ExistingViews}"></apex:selectOptions>
                                      <apex:actionSupport event="onchange" reRender="selectAllForCustomAndList" status="status" onsubmit=" renderListViewResults('{!JSENCODE(columnNamesForPage)}','{!JSENCODE(fieldLabels)}','{!JSENCODE(surveyRecipient)}',this.value,false,'{!JSENCODE(campaignType)}'); "/>
                                      <!--
                                        Commented below line and removed ,pgmsg from the rerender attribute, reason is if somone delete the listview in the middle of survey creation
                                        , it throws a standard salesforce page message exception along with the custom "no record found"
                                      <apex:actionSupport event="onchange" reRender="selectAllForCustomAndList,pgmsg" status="status" onsubmit=" renderListViewResults('{!JSENCODE(columnNamesForPage)}','{!JSENCODE(fieldLabels)}','{!JSENCODE(surveyRecipient)}',this.value,false,'{!JSENCODE(campaignType)}'); "/>
                                      
                                      -->
                                  </apex:selectList>
                                  <input type="button" src="s.gif" onclick="refreshList();" class="btn" title="Refresh" style="height: 22px;background-position: 2px 3px;background: url(/img/alohaSkin/sync.png) top left no-repeat;width: 23px;background-position: 2px 2px;vertical-align: bottom;"/>
                                  
                                </td>
                             </tr>
                            </table>
                           </apex:outputPanel>
                       <!-- List View : End -->
                       <apex:actionFunction name="refreshReport" status="status"  reRender="filterCriterias, buttons, recipientFilterButtons, pgmsg" action="{!setFilterCriteriaList}" onComplete="checkReportsLoaded('{!JSENCODE(selectedCriteriaType)}', '{!isProccessPending}');">
                            <!--<apex:param value="Existing Report" assignTo="{!selectedCriteriaType}"/>-->
                        </apex:actionFunction>
                        <apex:actionFunction name="refreshList" status="status"  reRender="filterCriterias, buttons, recipientFilterButtons, pgmsg" action="{!setFilterCriteriaList}" onComplete="if('{!JSENCODE(FilterId)}'!=null && '{!JSENCODE(FilterId)}'!=''){ renderListViewResults('{!JSENCODE(columnNamesForPage)}','{!JSENCODE(fieldLabels)}','{!JSENCODE(surveyRecipient)}','{!JSENCODE(FilterId)}',false,'{!JSENCODE(campaignType)}');}">
                            <!--<apex:param value="Existing List View" assignTo="{!selectedCriteriaType}"/>-->
                        </apex:actionFunction>
                       <!-- For Report : Start -->
                           <apex:outputPanel id="reportPanel" rendered="{!selectedCriteriaType == 'Existing Report'}">
                                <apex:outputPanel id="reportFunctions">
                                    <apex:actionFunction name="populateAllReports" action="{!getAllReports}" reRender="rptpicklist, reportFunctions"  status="status" onComplete=" if('{!isProccessPending}'=='true'){populateAllReports();}"/>
                                </apex:outputPanel>
                                    <!-- <span style="color:red;"> &nbsp; &nbsp;
                                         {!if(surveyRecipient=='Contact' || surveyRecipient=='Lead' || surveyRecipient=='User','* This app shows only those reports which contains Id field (for lead reports, converted leads records will be excluded).',
                                                if(surveyRecipient=='Case', '* This app shows only those reports which contains Case Id field.',
                                                    if(surveyRecipient=='Campaign', '* This app shows only those reports which contains Campaign Id field.','')
                                                ) 
                                          )}
                                    </span> -->
                                    <br/>
                                    <table><tr>
                                        <td class="LeftColumn">
                                            {!$Label.Select_Report} 
                                            :
                                        </td>
                                        <td>
                                            <span style="bottom:7px;right:10px;" class="helpButton" id="reportPicklist-_help">
                                            <!-- <label for="{!$component.reportPicklist}" style="font-size: 100%;font-weight: bold;"></label> -->
                                            <img src="/s.gif" alt="" class="helpOrb" title="" />
                                            <script>
                                            sfdcPage.setHelp('reportPicklist', 'Reports must contain a {!surveyRecipient} ID');
                                            </script>
                                            </span>
                                            </td>
                                            <td> 
                                            <apex:outputPanel id="rptpicklist">
                                                <!-- <apex:pageMessages id="pgmsg"/> -->
                                                <apex:selectList value="{!selectedReportId}" size="1" id="reportPicklist">
                                                    <apex:selectOptions value="{!lstReport}" />
                                                    <apex:actionsupport event="onchange" 
                                                    action="{!getReportForPage}" 
                                                    reRender="rptpicklist" 
                                                    status="status" 
                                                    onComplete="if('{!jsencode(ReportRecordSoqlString)}'!=''){ renderReportResults('{!jsencode(ReportRecordSoqlString)}','{!JSENCODE(columnNamesForPage)}','{!JSENCODE(fieldLabels)}','{!JSENCODE(surveyRecipient)}',false, '{!JSENCODE(campaignType)}');} return false;"/>
                                                </apex:selectList>
                                                <input type="button" src="s.gif" onclick="refreshReport();" class="btn" title="Refresh" style="height: 22px;background-position: 2px 3px;background: url(/img/alohaSkin/sync.png) top left no-repeat;width: 23px;background-position: 2px 2px;vertical-align: bottom;"/>
                                                
                                               
                                            </apex:outputPanel>
                                            <script>
                                                $( document ).ready( function(){
                                                        populateAllReports();
                                                    } 
                                                );
                                            </script> 
                                        </td></tr>
                                    </table>
                            </apex:outputPanel>
                        <!-- For Report : End -->
                        
                        
                        <apex:actionFunction name="aSelectItem" action="{!doSelectItem}"  rerender="mps" status="status" >
                            <apex:param name="contextItem" value="" assignTo="{!contextItem}"/>
                        </apex:actionFunction>
                       
                        <apex:actionFunction name="aDeselectItem" action="{!doDeselectItem}" rerender="mps" status="status">
                            <apex:param name="contextItem" value="" assignTo="{!contextItem}"/>
                        </apex:actionFunction>  
                        
                        <!-- <apex:actionFunction name="refreshSelectedIdsAndCount" reRender="selectedRecIdsPanel" status="status"/> -->
                        
                        <apex:outputpanel rendered="{!campaigntype!='Triggered'}">
                        
                            <apex:outputPanel id="selectedRecIdsPanel">
                                <apex:inputHidden id="selectedRecIds" html-class="selectedRecIds" value="{!selectedRecIds}"/>
                            </apex:outputPanel>
                        
                            <table width="100%">
                            
                            <!-- <tr><td class="LeftColumn">&nbsp;</td><td> 
                                    <apex:outputPanel styleclass="selectAllForCustomAndList" style="display:none;">
                                        <apex:inputCheckbox onChange="selectDeselectAllInternal(this);" value="{!selectAll}" styleClass="selectAllHH" />
                                    </apex:outputPanel>
                            </td></tr> -->
                                
                            <tr><td class="LeftColumn">
                                <div style="display:none" id="filterMatches">
                                    {!$Label.Filter_Matches} : <apex:outputText id="totalRecords" styleclass="totalRecords" rendered="{!$ObjectType.EmailTemplate.fields.Body.Accessible}" value="{!totalRecords}" />
                                </div>    
                            </td><td >
                            
                                <!-- Related to Javascript Remoting : Start -->
                                    <div id='DataTableDiv'>
                                        <table id="rowDataTable">
                                        </table>
                                    </div>
                                <!-- Related to Javascript Remoting : End -->
                            </td></tr>
                            </table>
                        </apex:outputpanel>
                    </apex:outputPanel>
                
                </apex:outputPanel>
                
                <apex:outputPanel id="buttons">
                    <center> 
                        <apex:commandButton value="{!$Label.surveymonkey__Back}" onclick="if(confirm('{!JSENCODE($Label.surveymonkey__Your_changes_will_be_lost_are_you_sure)}')){returnToPrevious();} return false;"/>
                        <apex:commandButton value="{!$Label.surveymonkey__Cancel}"  action="{!Cancel}"/>
                        <apex:commandButton value="{!$Label.surveymonkey__Continue}" action="{!goToStepFourReport_new}" rendered="{!selectedCriteriaType == 'Existing Report' && campaignType!='Manual'}" id="btnReport"/>
                        <apex:commandButton value="{!$Label.surveymonkey__Continue}"  action="{!goToStepFour}" id="btnCustomOrListView" rendered="{!campaignType=='Manual' || selectedCriteriaType == 'Existing List View' || selectedCriteriaType == 'Custom' }"/>
                    </center>
                </apex:outputPanel>
                <apex:actionfunction name="returnToPrevious"  action="{!RedirectOnEmailTemplate}"/>
               </apex:pageblocksection>
    </apex:pageBlock>
    <!-- <apex:commandLink value="Demo" onClick="myDemo(); return false;"/> -->
    </apex:form>                
 
</apex:page>